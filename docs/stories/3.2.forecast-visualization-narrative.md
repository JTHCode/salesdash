# Story 3.2: Forecast Visualization & Narrative



## Status

Approved



## Story

**As a** hiring manager,

**I want** to see forecast vs actual charts with confidence ranges and narrative takeaways,

**so that** I understand the candidate's ability to communicate predictive insights.



## Acceptance Criteria

1. Time-series chart overlays actuals with forecasted values and shaded confidence interval.
2. Toggle controls allow users to switch forecast horizon or metric (where applicable).
3. Text narrative block summarizes "what the forecast suggests" and recommended focus points.
4. Chart and narrative update according to global filters while using precomputed forecasts (no on-the-fly training).



## Dependencies

- Story 3.1: Forecast Pipeline Preparation delivers the offline artifact and loader that power this visualization (status Ready for Done).
- Story 2.2: Time-Series Visualization ensures shared filter state and metric selection are available for reuse (status Done).
- Story 2.3: Regional Performance Heatmap confirms downstream components must respect global filters and caching conventions (status Done).



## Project Structure Notes

- Visualization logic belongs in `src/components/forecasting_viz.py`, with supporting utilities placed under `src/utils/` only if shared (avoid duplicating service helpers). [Source: architecture/source-tree.md#project-structure]
- Tests covering new helpers should live beside other visualization tests (e.g., `tests/test_forecasting_viz.py`) to keep coverage centralized. [Source: architecture/source-tree.md#project-structure]



## Tasks / Subtasks

- [x] Implement forecast visualization component (AC: 1, 4) [Source: architecture/core-services-implementation.md#3-forecasting-service-forecasting_servicepy]
  - [x] Load precomputed artifact via `services.load_forecast_results`, constrain rows to current filter window, and retain metadata columns (`type`, `lower_bound`, `upper_bound`, `method`, `horizon`). (AC: 1, 4) [Source: docs/stories/3.1.forecast-pipeline-preparation.md#completion-notes-list]
  - [x] Prepare Plotly-ready DataFrame/Series that separates actual and forecast traces and derives confidence-band bounds aligned to the timeline. (AC: 1) [Source: architecture/core-services-implementation.md#3-forecasting-service-forecasting_servicepy]
  - [x] Render a Plotly chart inside `forecasting_viz.render` with actual values as a solid line, forecast values as a contrasting line, and `fill='tonexty'` style for the confidence interval, matching component conventions. (AC: 1) [Source: architecture/visualization-components.md#kpi-cards-component-componentskpi_cardspy]

- [x] Add forecast interaction controls (AC: 2) [Source: architecture/streamlit-application-structure.md#main-app-apppy]
  - [x] Provide horizon options (e.g., 6/12 months) using Streamlit controls that persist in session state and feed back into `load_forecast_results` or downstream slicing. (AC: 2) [Source: docs/stories/2.1.date-range-metric-controls.md#tasks--subtasks]
  - [x] Respect shared metric selection from FilterState so toggling between revenue/profit reuses the existing metric column without duplicating UI. (AC: 2) [Source: docs/stories/2.2.time-series-visualization.md#dev-notes]

- [x] Generate forecast narrative block (AC: 3) [Source: docs/prd/epic-3-forecasting-showcase.md#story-3-2-forecast-visualization--narrative]
  - [x] Summarize key insights (trend direction, confidence band width, upcoming peaks) using computed stats and render with `st.markdown`/`st.info` styled container below the chart. (AC: 3) [Source: architecture/streamlit-application-structure.md#main-app-apppy]
  - [x] Highlight recommended focus points tied to the selected metric and horizon (e.g., "forecasted revenue growth in Q4"), ensuring narrative updates when filters or toggles change. (AC: 3) [Source: docs/stories/2.3.regional-performance-heatmap.md#dev-notes]

- [x] Wire component into app layout and caching strategy (AC: 4) [Source: architecture/streamlit-application-structure.md#main-app-apppy]
  - [x] Update `src/app.py` to pass the shared filter state (dates, countries, statuses, metric labels) into `forecasting_viz.render` without introducing new global state. (AC: 4) [Source: docs/stories/2.2.time-series-visualization.md#dev-notes]
  - [x] Ensure the component never triggers on-the-fly model training; reuse cached artifact and respect cache TTL guidance. (AC: 4) [Source: architecture/performance-optimization.md#caching-strategy]

- [x] Add automated coverage for forecast helpers (AC: 4) [Source: architecture/testing-strategy.md#unit-tests-pytest]
  - [x] Introduce unit tests that validate data shaping (actual vs forecast split, confidence band math) and narrative summary functions using fixture data. (AC: 4) [Source: docs/stories/3.1.forecast-pipeline-preparation.md#completion-notes-list]
  - [x] Confirm toggles impact the returned dataset (different horizons/metrics) without breaking cache usage. (AC: 2, 4) [Source: architecture/performance-optimization.md#caching-strategy]

- [x] Document manual verification steps (AC: 1-4) [Source: architecture/testing-strategy.md#local-testing]
  - [x] Update Testing section with guidance to run `streamlit run src/app.py`, exercise horizon/metric toggles, and confirm chart + narrative update in sync with global filters. (AC: 1-4) [Source: docs/prd/epic-3-forecasting-showcase.md#story-3-2-forecast-visualization--narrative]
  - [x] Capture expected screenshots or descriptions for QA to validate overlay accuracy and narrative coherence. (AC: 1-3) [Source: architecture/testing-strategy.md#local-testing]



## Dev Notes

### Previous Story Insights

- Story 3.1 delivered the moving-average artifact (`data/processed/forecast_sales.csv`) and `services.load_forecast_results`, so the visualization must consume that precomputed output instead of recalculating forecasts. [Source: docs/stories/3.1.forecast-pipeline-preparation.md#completion-notes-list]
- Story 2.2 established shared filter state (dates, metric, ranges); reuse those selections when slicing forecast data or labeling traces to keep the experience consistent. [Source: docs/stories/2.2.time-series-visualization.md#dev-notes]
- Story 2.3 emphasized honoring global filters and cached helpers for downstream visuals; maintain the same pattern to avoid regressions when users pivot regions or statuses. [Source: docs/stories/2.3.regional-performance-heatmap.md#dev-notes]

### Data Models

- Forecast artifact rows include `period_start`, `value`, `type`, `lower_bound`, `upper_bound`, `method`, `horizon`, and training metadata; leverage these fields when building chart traces and tooltips. [Source: architecture/core-services-implementation.md#3-forecasting-service-forecasting_servicepy]
- Continue referencing canonical sales fields (`Order Date`, `Sales`, `Total Profit/Loss`) for axis labels and metric selection so the visualization aligns with other components. [Source: architecture/data-architecture.md#data-model]

### API Specifications

- Forecast data is accessed via in-process helpers (`services.load_forecast_results`) with caching, eliminating the need for external endpoints. [Source: docs/stories/3.1.forecast-pipeline-preparation.md#dev-notes]
- All transformations and rendering occur within the Streamlit runtime; respect the existing analytics service interfaces when mapping filters to datasets. [Source: architecture/high-level-architecture.md#system-overview]

### Component Specifications

- Implement visualization logic inside `components/forecasting_viz.py`, following the same pattern as other Plotly components (build data prep helpers, return Streamlit-friendly layout). [Source: architecture/source-tree.md#project-structure]
- Use Plotly 5.18+ to render line charts and confidence bands, matching styling conventions demonstrated by existing visualizations. [Source: architecture/tech-stack.md#visualization]
- Keep layout consistent with the main app (subheader, chart, expandable narrative/insights) and ensure components cooperate with `st.divider()` spacing. [Source: architecture/streamlit-application-structure.md#main-app-apppy]

### File Locations

- Core component updates belong in `src/components/forecasting_viz.py`; helper logic that might be reused can sit in `src/utils/plotting.py` if it benefits other charts. [Source: architecture/source-tree.md#project-structure]
- Persist any supporting fixture or sample data for tests under `tests/fixtures/` if needed, and add new tests to `tests/test_forecasting_viz.py`. [Source: architecture/source-tree.md#project-structure]

### Testing Requirements

- Extend pytest coverage to validate data shaping and narrative helpers, mirroring existing visualization tests to maintain consistent structure. [Source: architecture/testing-strategy.md#unit-tests-pytest]
- Manual smoke tests should run `streamlit run src/app.py`, switch horizons/metrics, and validate overlay accuracy, confidence band rendering, and narrative updates. [Source: architecture/testing-strategy.md#local-testing]

### Technical Constraints

- Adhere to the documented stack: Streamlit 1.29+, Plotly 5.18+, Pandas 2.1+, NumPy 1.26+, and cached operations via `st.cache_data`. [Source: architecture/tech-stack.md#visualization]
- Leverage cached artifact reads and avoid recomputation, aligning with the performance optimization guidelines for forecasting workloads. [Source: architecture/performance-optimization.md#caching-strategy]



## Testing

- Run `python -m pytest -k forecasting_viz` (or equivalent targeted suite) to verify unit test coverage for data shaping and narrative helpers. [Source: architecture/testing-strategy.md#unit-tests-pytest]
- Launch `streamlit run src/app.py` and interact with horizon/metric toggles to confirm the chart, confidence band, and narrative respond to filter changes without triggering retraining. [Source: architecture/testing-strategy.md#local-testing]
- Validate narrative copy against forecast trends (e.g., rising vs declining windows) to ensure insights stay truthful and actionable. [Source: docs/prd/epic-3-forecasting-showcase.md#story-3-2-forecast-visualization--narrative]



## Change Log

| Date       | Version | Description                                | Author |
|------------|---------|--------------------------------------------|--------|
| 2025-10-02 | v0.1    | Initial draft of Story 3.2                 | Bob (Scrum Master) |
| 2025-10-02 | v0.2    | Implemented forecast visualization & narrative experience | James (Dev) |



## Dev Agent Record

### Agent Model Used

- GPT-5 (Codex)

### Debug Log References

- `python -m pytest`

### Completion Notes List

- Replaced the placeholder forecasting component with horizon controls, confidence bands, and a cached narrative that respects shared filter state.
- Loaded the offline artifact via `services.load_forecast_results` and ensured the chart/narrative stay in sync with global metric selection.
- Added unit coverage in `tests/test_forecasting_viz.py` and ran `python -m pytest` (27 passed).

### File List

- src/components/forecasting_viz.py
- src/app.py
- tests/test_forecasting_viz.py

## QA Results





