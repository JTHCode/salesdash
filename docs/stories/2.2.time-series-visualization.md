# Story 2.2: Time-Series Visualization

## Status
Ready for Review

## Story
**As an** analyst,
**I want** a time-series chart displaying sales and profit trends by selected interval,
**so that** I can observe momentum and identify inflection points.

## Acceptance Criteria
1. Plotly line/area chart renders aggregated values per chosen interval (monthly/quarterly/yearly).
2. Users can toggle between intervals and metric focus; chart updates immediately.
3. Hover tooltips surface period values and deltas; annotations highlight notable peaks/troughs.
4. Performance stays within two-second response thanks to cached data transformations.

## Dependencies
- Story 2.1: Date Range & Metric Controls provides the shared filter state and metric selection consumed by time-series visuals (status Done).
- Story 1.3: Data Utility & Caching Layer exposes cached aggregation helpers (`aggregate_time_series`) that should be leveraged for efficient chart updates (status Done).

## Project Structure Notes
- Place the time-series chart component under `src/components/time_series.py`, replacing the existing placeholder per the architecture's component layout. [Source: architecture/source-tree.md#project-structure]
- Register any new helper modules within the `components` package and keep tests under `tests/` (e.g., `tests/test_time_series.py`) to align with the source tree structure. [Source: architecture/source-tree.md#project-structure]

## Tasks / Subtasks
- [x] Replace placeholder time-series component with interactive chart (AC: 1, 3) [Source: architecture/core-services-implementation.md#get_time_series_data]
  - [x] Fetch aggregated data via `aggregate_time_series` using the selected interval and chosen metric column. (AC: 1) [Source: architecture/core-services-implementation.md#get_time_series_data]
  - [x] Render a Plotly line or area chart reflecting the aggregated series, including proper axis labels and titles driven by the active metric. (AC: 1) [Source: architecture/visualization-components.md#visualization-components]
  - [x] Configure hover tooltips to display period values and percent changes; include annotations for peaks/troughs when readily derivable. (AC: 3) [Source: architecture/visualization-components.md#visualization-components]
- [x] Add interval and metric toggles to the chart (AC: 2) [Source: architecture/streamlit-application-structure.md#main-app-apppy]
  - [x] Provide controls (e.g., buttons or radio group) to select monthly/quarterly/yearly aggregation and propagate the choice to the chart rendering logic. (AC: 2) [Source: architecture/streamlit-application-structure.md#main-app-apppy]
  - [x] Ensure the chart respects the primary metric from Story 2.1, allowing overrides if the user toggles between metrics inside the component. (AC: 2) [Source: architecture/visualization-components.md#visualization-components]
- [x] Maintain cached performance characteristics (AC: 4) [Source: architecture/performance-optimization.md#caching-strategy]
  - [x] Rely on the cached aggregation helper and avoid recomputing full datasets on each interaction, keeping response within two seconds. (AC: 4) [Source: architecture/performance-optimization.md#caching-strategy]
  - [x] Document any additional caching or memoization in the component docstring so downstream stories understand the performance behavior. (AC: 4) [Source: architecture/performance-optimization.md#caching-strategy]
- [x] Update application wiring for interval state (AC: 2, 4) [Source: architecture/streamlit-application-structure.md#main-app-apppy]
  - [x] Extend `src/app.py` (or the shared filter controls) to capture the interval choice and pass it through to the time-series component. (AC: 2) [Source: architecture/streamlit-application-structure.md#main-app-apppy]
  - [x] Ensure KPI cards or other consumers remain unaffected by the interval selection unless explicitly required by later stories. (AC: 2) [Source: architecture/visualization-components.md#visualization-components]
- [x] Add automated visualization tests (AC: 3) [Source: architecture/testing-strategy.md#unit-tests-pytest]
  - [x] Write pytest coverage validating the aggregation helper usage, ensuring sample DataFrames produce expected output for monthly/quarterly/yearly intervals. (AC: 1,2) [Source: architecture/core-services-implementation.md#get_time_series_data]
  - [x] Include tests that confirm chart configuration (e.g., trace count, axis titles) matches the selected metric and interval. (AC: 3) [Source: architecture/visualization-components.md#visualization-components]
- [x] Document manual testing steps (AC: 1-3) [Source: architecture/testing-strategy.md#local-testing]
  - [x] Update the Testing section with instructions for running `streamlit run src/app.py`, toggling intervals/metrics, and verifying tooltips/annotations. (AC: 1-3) [Source: architecture/testing-strategy.md#local-testing]
  - [x] Note in the README or inline docs any new controls added to the app sidebar or main layout. (AC: 2) [Source: architecture/streamlit-application-structure.md#main-app-apppy]

## Dev Notes
### Previous Story Insights
- Story 2.1 introduces shared filter state (`FilterState`) containing date ranges and primary metric labels; time-series components should read from this state instead of directly accessing Streamlit widgets. [Source: docs/stories/2.1.date-range-metric-controls.md]
- Story 1.3 added `aggregate_time_series` with caching support; rely on this helper rather than recomputing aggregations manually. [Source: docs/stories/1.3.data-utility-and-caching-layer.md]

### Data Models
- Aggregations operate on canonical fields: `Order Date`, `Sales`, `Total Profit/Loss`, `Quantity Ordered`. Ensure chart selection references these columns. [Source: architecture/data-architecture.md#data-model]

### API Specifications
- All transformations occur within the Streamlit process, invoking cached helpers and returning Pandas DataFrames for Plotly consumption. No external APIs are required. [Source: architecture/high-level-architecture.md#system-overview]

### Component Specifications
- Place the Plotly visualization logic inside `components/time_series.py`, keeping the component focused on rendering and delegating data prep to the service layer. [Source: architecture/visualization-components.md#visualization-components]
- Support responsive layout and align styling with the existing Streamlit theme defined in `.streamlit/config.toml`. [Source: architecture/streamlit-application-structure.md#main-app-apppy]

### File Locations
- Time-series rendering lives in `src/components/time_series.py` per the component structure; ancillary utilities (if any) belong under `src/utils/` following naming conventions. [Source: architecture/source-tree.md#project-structure]
- Store new tests in `tests/` (e.g., `tests/test_time_series.py`) to keep analytics coverage centralised. [Source: architecture/source-tree.md#project-structure]

### Testing Requirements
- Follow the pytest strategy for unit coverage, mocking aggregated data where appropriate to verify chart construction logic. [Source: architecture/testing-strategy.md#unit-tests-pytest]
- Manual validation requires running the Streamlit app and observing chart responsiveness under various intervals and metrics. [Source: architecture/testing-strategy.md#local-testing]

### Technical Constraints
- Maintain compatibility with Python 3.11+, Streamlit 1.29+, Plotly 5.18+, honoring the caching expectations set by the performance guidelines. [Source: architecture/tech-stack.md#technology-stack]
- Keep interactions under the two-second response threshold by leaning on cached data and avoiding redundant computations. [Source: architecture/performance-optimization.md#caching-strategy]

## Testing
- Execute `pytest` (including the new time-series tests) to confirm aggregation and chart configuration behavior. [Source: architecture/testing-strategy.md#unit-tests-pytest]
- Run `streamlit run src/app.py` to verify the time-series visualization responds instantly to interval/metric toggles, showing tooltips and annotations. [Source: architecture/testing-strategy.md#local-testing]

## Change Log
| Date       | Version | Description                        | Author |
| 2025-10-01 | v0.2    | Time-series visualization implemented and ready for review | James (Dev Agent) |
|------------|---------|------------------------------------|--------|
| 2025-10-01 | v0.1    | Initial draft of Story 2.2         | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
OpenAI GPT-5 (Codex)

### Debug Log References
- `.\venv\Scripts\python.exe -m pytest`

### Completion Notes List
- Replaced the time-series placeholder with a cached Plotly area chart supporting interval toggles.
- Wired interval and metric state through the shared filter controls without affecting KPI behaviour.
- Added unit tests covering time-series aggregation prep and chart configuration.

### File List
- src/app.py
- src/components/time_series.py
- src/components/__init__.py
- tests/test_time_series.py

## QA Results



