# Story 2.3: Regional Performance Heatmap

## Status
Ready for Review

## Story
**As a** business stakeholder,
**I want** a geographic heatmap showing revenue density with hoverable detail,
**so that** I can compare regional performance at a glance.

## Acceptance Criteria
1. Map component (Plotly choropleth or similar) displays the static dataset aggregated by region/state.
2. Hover tooltips expose revenue, profit margin, and growth for the hovered region.
3. Secondary table or card stack lists top/bottom regions matching filters.
4. Map respects selected metric and date filters.

## Dependencies
- Story 2.1: Date Range & Metric Controls provides shared filter and metric selections that the map must consume (status Done).
- Story 2.2: Time-Series Visualization ensures interval/metric wiring in `src/app.py`; heatmap should reuse the same state (status Done).
- Story 1.3: Data Utility & Caching Layer exposes `get_geographic_data` for performant aggregations (status Done).

## Project Structure Notes
- Implement the map in `src/components/geographic_map.py`, replacing the placeholder in accordance with the component layout. [Source: architecture/source-tree.md#project-structure]
- If a supporting ranking table component is created, place it within `src/components/` and expose it through `__init__.py` for consistency. [Source: architecture/source-tree.md#project-structure]

## Tasks / Subtasks
- [x] Replace geographic map placeholder with production choropleth (AC: 1, 2) [Source: architecture/visualization-components.md#geographic-map-component-componentsgeographic_mappy]
  - [x] Use `get_geographic_data` to aggregate filtered results and feed a Plotly choropleth with country/state granularity. (AC: 1) [Source: architecture/core-services-implementation.md#get_geographic_data]
  - [x] Configure hover templates to show revenue, profit margin, and growth values derived from the dataset. (AC: 2) [Source: architecture/visualization-components.md#geographic-map-component-componentsgeographic_mappy]
- [x] Add regional ranking view alongside the map (AC: 3) [Source: architecture/visualization-components.md#geographic-map-component-componentsgeographic_mappy]
  - [x] Render a table or expandable card stack listing top/bottom regions based on the active metric and filters. (AC: 3) [Source: architecture/visualization-components.md#geographic-map-component-componentsgeographic_mappy]
  - [x] Ensure formatting (currency/margins) matches existing dashboard standards. (AC: 3) [Source: architecture/tech-stack.md#technology-stack]
- [x] Respect shared metric/date filters (AC: 1, 4) [Source: architecture/streamlit-application-structure.md#main-app-apppy]
  - [x] Consume the `FilterState` metric selection so the heatmap toggles between revenue/profit views without reloading the app. (AC: 4) [Source: docs/stories/2.1.date-range-metric-controls.md]
  - [x] Confirm the map responds to date range and other filters by reusing the filtered DataFrame produced in `src/app.py`. (AC: 4) [Source: architecture/streamlit-application-structure.md#main-app-apppy]
- [x] Wire map controls into the application layout (AC: 1-4) [Source: architecture/streamlit-application-structure.md#main-app-apppy]
  - [x] Update `src/app.py` to pass metric information into `geographic_map.render` similar to the time-series component. (AC: 2, 4) [Source: architecture/streamlit-application-structure.md#main-app-apppy]
  - [x] Maintain performance expectations by leveraging cached helper results and avoiding repeated heavy computations. (AC: 4) [Source: architecture/performance-optimization.md#caching-strategy]
- [x] Add automated coverage for geographic aggregation and rendering (AC: 2, 3) [Source: architecture/testing-strategy.md#unit-tests-pytest]
  - [x] Create pytest coverage ensuring `get_geographic_data` outputs feed the choropleth and ranking utilities as expected. (AC: 2, 3) [Source: architecture/core-services-implementation.md#get_geographic_data]
  - [x] Validate tooltip text and ranking output formatting using representative sample data. (AC: 2, 3) [Source: architecture/visualization-components.md#geographic-map-component-componentsgeographic_mappy]
- [x] Document manual validation steps (AC: 1-4) [Source: architecture/testing-strategy.md#local-testing]
  - [x] Update the Testing section with instructions for running `streamlit run src/app.py`, switching metrics, and reviewing hover/table behaviour. (AC: 1-4) [Source: architecture/testing-strategy.md#local-testing]
  - [x] Mention any README updates if new dependencies or instructions are required. (AC: 4) [Source: architecture/streamlit-application-structure.md#main-app-apppy]

## Dev Notes
### Previous Story Insights
- Story 2.2 established interval-aware metric selection; the heatmap should reuse the same filter context without duplicating controls. [Source: docs/stories/2.2.time-series-visualization.md]
- Story 1.3's cached helpers (`get_geographic_data`) should be used to avoid performance regressions when map filters change. [Source: docs/stories/1.3.data-utility-and-caching-layer.md]

### Data Models
- Aggregations rely on fields such as `Country`, `Sales`, `Total Profit/Loss`, `Profit Margin` provided by the standardised dataset. [Source: architecture/data-architecture.md#data-model]

### API Specifications
- No external APIs required; the map consumes in-process data and renders via Plotly components. [Source: architecture/high-level-architecture.md#system-overview]

### Component Specifications
- `components/geographic_map.py` should manage rendering, using Plotly choropleth and an accompanying table per the visualization guidelines. [Source: architecture/visualization-components.md#geographic-map-component-componentsgeographic_mappy]
- Ensure the component communicates clearly when filters yield no data, matching existing UX patterns. [Source: architecture/visualization-components.md#geographic-map-component-componentsgeographic_mappy]

### File Locations
- Place map logic in `src/components/geographic_map.py`; if helper utilities are needed, add them to `src/utils/` following naming conventions. [Source: architecture/source-tree.md#project-structure]
- Store tests under `tests/` (e.g., `tests/test_geographic_map.py`) to centralise visualization coverage. [Source: architecture/source-tree.md#project-structure]

### Testing Requirements
- Follow the pytest approach to validate data aggregation and rendering behaviours, using sample DataFrames for deterministic assertions. [Source: architecture/testing-strategy.md#unit-tests-pytest]
- Manual testing should include launching the app, adjusting filters/metrics, and verifying both map and ranking elements respond correctly. [Source: architecture/testing-strategy.md#local-testing]

### Technical Constraints
- Maintain compatibility with Streamlit 1.29+ and Plotly 5.18+, and respect caching expectations to keep interactions under two seconds. [Source: architecture/tech-stack.md#technology-stack]
- Ensure the component degrades gracefully if Plotly cannot render (e.g., display warning). [Source: architecture/performance-optimization.md#caching-strategy]

## Testing
- Execute `pytest` (including new geographic map tests) to confirm aggregation logic and rendering configuration. [Source: architecture/testing-strategy.md#unit-tests-pytest]
- Run `streamlit run src/app.py` to validate hover tooltips, ranking table, and metric/date responsiveness. [Source: architecture/testing-strategy.md#local-testing]

## Change Log
| Date       | Version | Description                        | Author |
| 2025-10-01 | v0.2    | Geographic heatmap implemented and ready for review | James (Dev Agent) |
|------------|---------|------------------------------------|--------|
| 2025-10-01 | v0.1    | Initial draft of Story 2.3         | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
OpenAI GPT-5 (Codex)

### Debug Log References
- `.\venv\Scripts\python.exe -m pytest`

### Completion Notes List
- Delivered Plotly choropleth and ranking table driven by cached geographic aggregations.
- Hooked metric/date filters into the map without impacting upstream components.
- Added pytest coverage for geographic data preparation and rendering helpers.

### File List
- src/app.py
- src/components/geographic_map.py
- src/components/__init__.py
- src/services/analytics_service.py
- tests/test_geographic_map.py

## QA Results

