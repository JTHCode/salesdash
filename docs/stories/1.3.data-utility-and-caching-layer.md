# Story 1.3: Data Utility & Caching Layer



## Status



Done



## Story



**As a** developer,



**I want** shared utility functions for aggregations, period comparisons, and caching,



**so that** downstream features can reuse optimized computations without performance regressions.



## Acceptance Criteria



1. Utility module exposes functions for computing KPI aggregates and time-based slices with docstrings.



2. Streamlit caching (`@st.cache_data`) wraps expensive computations to keep response times under two seconds.



3. Unit tests cover KPI utility behavior using sample dataset slices.



4. KPI summary cards integrate with utilities and log key actions for debugging in Streamlit.



## Dependencies



- Story 1.2: KPI Summary Cards MVP provides the KPI rendering surface that will consume these utilities (status Done).



## Project Structure Notes



- Analytics helpers must live under `src/services/analytics_service.py`, with shared transformations optionally placed in `src/utils/data_processing.py`, matching the prescribed module layout. [Source: architecture/source-tree.md#project-structure]



- Analytics-focused tests should continue to live in `tests/test_analytics.py` to align with the organized test suite structure. [Source: architecture/source-tree.md#project-structure]



## Tasks / Subtasks



- [x] Expand analytics utility layer for reusable computations (AC: 1) [Source: architecture/core-services-implementation.md#2-analytics-service-analytics_servicepy]



  - [x] Refactor or extend `analytics_service` so KPI aggregation, comparison windows, and time-slice helpers expose docstring-documented functions ready for reuse. (AC: 1) [Source: architecture/core-services-implementation.md#2-analytics-service-analytics_servicepy]



  - [x] Add helper to generate rolling or period-based aggregations that downstream charts can call, returning Pandas DataFrames consistent with architecture expectations. (AC: 1) [Source: architecture/core-services-implementation.md#2-analytics-service-analytics_servicepy]



- [x] Implement consistent caching for analytics utilities (AC: 2) [Source: architecture/performance-optimization.md#caching-strategy]



  - [x] Apply `@st.cache_data` decorators with descriptive cache keys to heavy analytics helpers while respecting invalidation needs when filters change. (AC: 2) [Source: architecture/core-services-implementation.md#2-analytics-service-analytics_servicepy]



  - [x] Document cache usage and TTL expectations in module docstrings so future developers understand refresh semantics. (AC: 2) [Source: architecture/performance-optimization.md#caching-strategy]



- [x] Integrate utilities with KPI cards and logging hooks (AC: 4) [Source: architecture/visualization-components.md#kpi-cards-component-componentskpi_cardspy]



  - [x] Update `components/kpi_cards.py` to call the new utility entry points and emit informative Streamlit messages during compute phases. (AC: 4) [Source: architecture/error-handling.md#example-error-handling-pattern]



  - [x] Ensure messaging clearly indicates cache hits, misses, or fallbacks to aid debugging within the UI. (AC: 4) [Source: architecture/error-handling.md#example-error-handling-pattern]



- [x] Build analytics-focused unit tests (AC: 3) [Source: architecture/testing-strategy.md#unit-tests-pytest]



  - [x] Cover KPI aggregate, comparison, and time-slice utilities with representative dataset slices, including empty-data edge cases. (AC: 3) [Source: architecture/testing-strategy.md#unit-tests-pytest]



  - [x] Validate caching behavior by asserting deterministic outputs across repeated calls and documenting observed performance improvements. (AC: 2,3) [Source: architecture/performance-optimization.md#caching-strategy]



- [x] Update developer documentation and manual validation steps (AC: 2,4) [Source: architecture/testing-strategy.md#local-testing]



  - [x] Record manual smoke instructions in this story's Testing section for verifying cache behavior and KPI integration via `streamlit run src/app.py`. (AC: 4) [Source: architecture/testing-strategy.md#local-testing]



  - [x] Ensure README or inline module comments reflect the new utility responsibilities without duplicating architecture content. (AC: 1,4) [Source: architecture/core-services-implementation.md#2-analytics-service-analytics_servicepy]



## Dev Notes



### Previous Story Insights



- KPI rendering already calls service-level helpers, so maintain the separation between computation and presentation described for `analytics_service`. [Source: architecture/core-services-implementation.md#2-analytics-service-analytics_servicepy]



### Data Models



- Utilities must operate on the canonical sales dataset schema (e.g., `Sales`, `Total Profit/Loss`, `Quantity Ordered`, `Order Date`, `Country`) standardized by the data architecture. [Source: architecture/data-architecture.md#data-model]



### API Specifications



- Analytics helpers are in-process Python functions invoked directly by Streamlit components, avoiding external services. [Source: architecture/high-level-architecture.md#system-overview]



- Utility functions should return dictionaries or DataFrames matching the analytics service patterns to stay compatible with UI consumers. [Source: architecture/core-services-implementation.md#2-analytics-service-analytics_servicepy]



### Component Specifications



- `components/kpi_cards.py` must continue to rely on service-level helpers for KPI metrics and comparisons, keeping rendering logic separate from calculations. [Source: architecture/visualization-components.md#kpi-cards-component-componentskpi_cardspy]



- Streamlit messaging (info/warning) should clarify cache status or issues, following the error-handling pattern for user-facing diagnostics. [Source: architecture/error-handling.md#example-error-handling-pattern]



### File Locations



- Place shared computation helpers under `src/services/analytics_service.py`, with optional reusable transformations under `src/utils/data_processing.py`, reflecting the source tree layout. [Source: architecture/source-tree.md#project-structure]



- House new analytics unit tests in `tests/test_analytics.py` to keep regression coverage centralized. [Source: architecture/source-tree.md#project-structure]



### Testing Requirements



- Follow the pytest structure for analytics validation, covering aggregation correctness, comparison math, and cache determinism. [Source: architecture/testing-strategy.md#unit-tests-pytest]



- Include manual testing guidance for running `streamlit run src/app.py` and inspecting KPI updates after cache warm-up. [Source: architecture/testing-strategy.md#local-testing]



### Technical Constraints



- Maintain compatibility with Python 3.11+, Streamlit 1.29+, and enforce `@st.cache_data` usage to honor performance objectives. [Source: architecture/tech-stack.md#technology-stack]



- Align with the caching expectations outlined in the performance guidelines to keep response times under two seconds. [Source: architecture/performance-optimization.md#caching-strategy]



## Testing



- Execute `pytest tests/test_analytics.py` focusing on the new utility scenarios (aggregates, comparisons, caching determinism). [Source: architecture/testing-strategy.md#unit-tests-pytest]



- Run `streamlit run src/app.py` to verify KPI cards leverage the utility layer, logging cache status and responding swiftly to filter changes. [Source: architecture/testing-strategy.md#local-testing]



## Change Log



| Date       | Version | Description                        | Author |

|------------|---------|------------------------------------|--------|

| 2025-10-01 | v0.2    | Data utility layer implemented and ready for review | James (Dev Agent) |

| 2025-10-01 | v0.1    | Initial draft of Story 1.3         | Bob (Scrum Master) |



## Dev Agent Record



### Agent Model Used



OpenAI GPT-5 (Codex)



### Debug Log References



- `.\venv\Scripts\python.exe -m pytest`



### Completion Notes List



- Expanded analytics service with cached comparison and time-series helpers.



- Updated KPI cards to use the shared utilities and emit Streamlit diagnostics.



- Broadened analytics tests to cover comparison windows, aggregations, and deterministic caching.



### File List



- src/services/analytics_service.py



- src/components/kpi_cards.py



- tests/test_analytics.py



## QA Results



