# Story 2.1: Date Range & Metric Controls



## Status

Done



## Story

**As a** dashboard viewer,

**I want** intuitive controls to adjust date ranges and choose revenue vs profit metrics,

**so that** subsequent charts and summaries reflect the slice I care about.



## Acceptance Criteria

1. UI presents date picker (or presets) plus metric selection toggle.

2. Selected filters flow into shared state accessed by charts and KPI cards.

3. Controls persist selections across reruns and default to a sensible recent period.

4. Unit tests verify filter handlers update state objects correctly.



## Dependencies

- Story 1.3: Data Utility & Caching Layer delivers reusable analytics helpers that must react to updated filter selections (status Done).



## Project Structure Notes

- Place filter control logic under `src/components/` and wire through `src/app.py` so the sidebar remains the orchestrator defined by the application structure. [Source: architecture/source-tree.md#project-structure]

- Locate automated tests in `tests/` (e.g., extend `tests/test_filter_controls.py` or similar) to follow the prescribed testing layout. [Source: architecture/source-tree.md#project-structure]



## Tasks / Subtasks

- [x] Implement unified filter controls component (AC: 1, 3) [Source: architecture/streamlit-application-structure.md#main-app-apppy]

  - [x] Build a Streamlit sidebar component that exposes paired start/end selectors with presets (e.g., last 30/90/365 days) and a metric toggle between revenue and profit. (AC: 1, 3) [Source: architecture/streamlit-application-structure.md#main-app-apppy]

  - [x] Default the controls to the recent-period baseline (last 365 days) used in the architecture example while allowing custom ranges. (AC: 3) [Source: architecture/streamlit-application-structure.md#main-app-apppy]

- [x] Persist selections and publish shared state (AC: 2, 3) [Source: architecture/streamlit-application-structure.md#main-app-apppy]

  - [x] Use Streamlit session state to retain control values across reruns and expose a normalized filter object other components can consume. (AC: 2, 3) [Source: architecture/streamlit-application-structure.md#main-app-apppy]

  - [x] Update `src/app.py` to translate the shared state into calls to `get_filtered_data` and the analytics utilities introduced in Story 1.3. (AC: 2) [Source: architecture/core-services-implementation.md#2-analytics-service-analytics_servicepy]

- [x] Integrate metric selection with downstream components (AC: 2) [Source: architecture/visualization-components.md#kpi-cards-component-componentskpi_cardspy]

  - [x] Ensure KPI cards and future visualizations read the chosen metric from shared state when rendering values or chart traces. (AC: 2) [Source: architecture/visualization-components.md#kpi-cards-component-componentskpi_cardspy]

  - [x] Validate the metric choice passes through to cached analytics helpers without breaking performance expectations. (AC: 2) [Source: architecture/performance-optimization.md#caching-strategy]

- [x] Add automated filter handler coverage (AC: 4) [Source: architecture/testing-strategy.md#unit-tests-pytest]

  - [x] Write unit tests that exercise the filter state builder (preset selection, custom date entry, metric toggling) and assert correct integration with `get_filtered_data` arguments. (AC: 4) [Source: architecture/core-services-implementation.md#2-analytics-service-analytics_servicepy]

  - [x] Include regression assertions ensuring state persistence across multiple invocations in a single test session. (AC: 4) [Source: architecture/testing-strategy.md#unit-tests-pytest]

- [x] Document manual verification steps (AC: 1-3) [Source: architecture/testing-strategy.md#local-testing]

  - [x] Update this story's Testing section with guidance for running `streamlit run src/app.py` to confirm controls persist values and propagate to KPI cards/time-series previews. (AC: 1-3) [Source: architecture/testing-strategy.md#local-testing]

  - [x] Note any impacts to README or inline documentation so setup instructions stay current. (AC: 1) [Source: architecture/streamlit-application-structure.md#main-app-apppy]



## Dev Notes

### Previous Story Insights

- Story 1.3 introduced cached utilities (`build_comparison_window`, `aggregate_time_series`, `calculate_kpis`) that expect coherent filter inputs; ensure new controls feed these helpers consistently. [Source: docs/stories/1.3.data-utility-and-caching-layer.md]



### Data Models

- Control options should reference canonical sales fields already standardized by the data loader (`Order Date`, `Sales`, `Total Profit/Loss`). [Source: architecture/data-architecture.md#data-model]



### API Specifications

- Filters ultimately drive the in-process `get_filtered_data` call that composes the dataset for components keep interfaces aligned with that signature. [Source: architecture/core-services-implementation.md#2-analytics-service-analytics_servicepy]

- No external APIs are involved; stateful interactions remain within the Streamlit runtime. [Source: architecture/high-level-architecture.md#system-overview]



### Component Specifications

- Sidebar filters belong in the main app or dedicated components invoked from `src/app.py`, as illustrated in the application structure. [Source: architecture/streamlit-application-structure.md#main-app-apppy]

- KPI and chart components are expected to honor shared filter inputs; expose clear interfaces so they can stay presentation-focused. [Source: architecture/visualization-components.md#kpi-cards-component-componentskpi_cardspy]



### File Locations

- Place new UI control code under `src/components/` (e.g., `filter_controls.py`) and update `src/app.py` to import it, consistent with the source tree. [Source: architecture/source-tree.md#project-structure]

- Add or extend tests under `tests/` to maintain consolidated coverage for analytics and UI glue code. [Source: architecture/source-tree.md#project-structure]



### Testing Requirements

- Use pytest to cover handler logic and ensure filtered datasets respect selected ranges, as outlined in the testing strategy. [Source: architecture/testing-strategy.md#unit-tests-pytest]

- Manual verification should include launching `streamlit run src/app.py` and manipulating the new controls to confirm state persistence and downstream updates. [Source: architecture/testing-strategy.md#local-testing]



### Technical Constraints

- Stay within the documented stack (Python 3.11+, Streamlit 1.29+) and honor caching expectations when wiring filter-driven computations. [Source: architecture/tech-stack.md#technology-stack]

- Maintain sub-two-second responsiveness by keeping filter handlers lightweight and relying on cached analytics utilities. [Source: architecture/performance-optimization.md#caching-strategy]



## Testing

- Execute `pytest` (e.g., `.\venv\Scripts\python.exe -m pytest`) for the filter handler tests that accompany this story. [Source: architecture/testing-strategy.md#unit-tests-pytest]

- Run `streamlit run src/app.py` and verify control persistence, metric toggles, and KPI updates behave as expected. [Source: architecture/testing-strategy.md#local-testing]



## Change Log

| Date       | Version | Description                          | Author |

| 2025-10-01 | v0.2    | Filter controls implemented and ready for review | James (Dev Agent) |

|------------|---------|--------------------------------------|--------|

| 2025-10-01 | v0.1    | Initial draft of Story 2.1           | Bob (Scrum Master) |



## Dev Agent Record



### Agent Model Used

OpenAI GPT-5 (Codex)



### Debug Log References

- `.\venv\Scripts\python.exe -m pytest`



### Completion Notes List

- Added reusable sidebar filter controls with preset support and session persistence.

- Updated KPI cards to honour the selected primary metric and surface diagnostic captions.

- Introduced unit tests covering filter helpers and session defaults.



### File List

- src/app.py

- src/components/__init__.py

- src/components/filter_controls.py

- src/components/kpi_cards.py

- tests/test_filter_controls.py



## QA Results





